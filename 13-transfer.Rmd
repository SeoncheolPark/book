# 전이함수모형 {#transfer}

시차회귀분석(lagged regression)

입력시계열과 출력시계열로 사용되는 시계열 사이의 관계를 회귀모형의 형태로 표현한 것을 **전이함수(transfer function)**라고 하며, 이 떄의 모형을 **전이함수모형(transfer function model)**이라고 한다. 일반적으로 전이함수 모형은 입력시계열이 출력시계열에는 영향을 미치나 반대의 영향은 없다는 가정 하에서 사용한다. 만약 출력시계열도 입력시계열에 영향을 미치는 경우에는 전이함수 모형 대신 벡터 ARIMA 모형을 이용한 분석을 한다.

\begin{equation}\label{eq:lagreg}
y_{t}=\sum_{j=0}^{\infty}\alpha_{j}x_{t-j}+\eta_{t}=\alpha(B)x_{t}+\eta_{t}
\end{equation}

라고 모형을 세우자. 이 때 $x_{t-j}$는 입력시계열, $\eta_{t}$는 잡음과정이 되며
$$\alpha(B)=\sum_{j=0}^{\infty}\alpha_{j}B^{j}$$
는 전이함수가 된다. 이 때 $\alpha_{j}$를 **충격반응가중값(impulse response weight)**이라고 부른다.

Box와 Jenkins에 따르면, $x_{t}$와 $\eta_{t}$에 ARIMA모형을 적합한다. 이 때
$$\phi(B)x_{t}=\theta(B)w_{t} \text{ and }$$
$$\phi_{\eta}(B)\eta_{t}=\theta_{\eta}(B)z_{t}$$
로 표현할 수 있다. 이 때

- $w_{t},z_{t}$는 독립이고 분산이 $\sigma_{w}^{2}$, $\sigma_{z}^{2}$인 백색잡음과정이다. Box와 Jenkins는 $\alpha_{j}, j=1,2,\ldots$의 형태로 systematic patteren들이 관찰될 수 있고 이들을 a ratio of polynomials involving a small number of coefficients, along with a specified delay $d$로 표현할 수 있다고 한다. 따라서

$$\alpha(B)=\frac{\delta (B)B^{d}}{\omega(B)}$$
로 표현할 수 있고(이렇게 표현하면 추정해야 할 모수의 숫자를 줄일 수 있다고 한다), 여기서
$$\omega(B)=1-\omega_{1}B-\omega_{2}B^{2}-\cdots -\omega_{r}B^{r}$$
이며
$$\delta(B)=\delta_{0}+\delta_{1}B+\cdots +\delta_{s}B^{s}$$
들이 지시연산자가 된다. 식 (\@ref(eq:lagreg))를 정리하면
$$\tilde{y}_{t}=\frac{\phi(B)}{\theta(B)}y_{t}=\alpha(B)w_{t}+\frac{\phi(B)}{\theta(B)}\eta_{t}=\alpha(B)w_{t}+\tilde{\eta}_{t}$$
를 얻게 된다. 이 때

- $\alpha(B)=\sum_{j=0}^{\infty}\alpha_{j}B^{j}$: 전이함수

- $\tilde{\eta}_{t}$: 변환된 잡음으로 $w_{t}$와 독립

- $\frac{\phi(B)}{\theta(B)}$: **선형필터(linear filter)**라 부름

- $w_{t}$: 사전백색화된 input series

- $\tilde{y}_{t}$: 변환된 output series



전이함수모형의 기본 가정은 입력시계열과 반응시계열이 모두 정상시계열이라는 것이다. 따라서 먼저 분석에 사용될 시계열들이 정상성을 갖는지 여부를 판단해야 한다.

## 안정성과 인과성(stability and causality)

(조신섭 교수님 책 참고)

## 교차상관함수(cross-covariance function)

전이함수의 형태를 식별하기 위해서는 충격반응가중값을 먼저 구해야 하는데, 이를 위해 두 개의 시계열 사이의 상관의 정도와 방향을 나타내는 교차상관함수를 이용한다.

<div class="definition">

**(교차상관함수)** 정상인 두 시계열 $X_{t}$와 $Y_{t}$ 사이의 교차상관함수는
$$\gamma_{XY}(t)=E[(X_{t}-\mu_{X})(Y_{t+k}-\mu_{Y})], \qquad{k=0,\pm 1, \pm 2, \ldots}$$
이다. 단 모든 $t$에 대해 $\mu_{X}=E[X_{t}]$, $\mu_{Y}=E[Y_{t}]$이다.

</div>

교차상관함수의 성질 중 중요한 것은 **자기상관함수와는 달리 대칭이 아니라**는 점이다. 따라서 교차상관함수는 자기상관함수와는 달리 상관의 정도와 영향을 미치는 방향을 같이 측정한다는 점이 특징이다.

<div class="definition">

**(교차상관계수)** 정상인 두 시계열 $X_{t}$와 $Y_{t}$ 사이의 교차상관함수는
$$\rho_{XY}(k)=Corr(X_{t},Y_{t+k})=\frac{\gamma_{XY}(k)}{\sigma_{X}\sigma_{Y}}=\frac{\gamma_{XY}(k)}{\sqrt{\gamma_{X}(0)\gamma_{Y}(0)}}$$
으로 정의한다.

</div>

앞선 모형에서 $\tilde{y}_{t}$와 $w_{t}$의 교차상관계수는
$$\gamma_{\tilde{y} w}(h)=E[\tilde{y}_{t} w_{t}]=E[\sum_{j=0}^{\infty}\alpha_{j}w_{t+h-j}w_{t}]=\sigma_{w}^{2}\alpha_{h}$$
로 쓸 수 있다. 이는 $j=h$일 때를 제외하고 백색잡음의 ACF가 0임을 이용하는 것이다. 이 관계식을 보면
$$\hat{\alpha}_{h}=\frac{\hat{\gamma}_{\tilde{y}w}(h)}{\hat{\sigma}_{w}^{2}}$$
임을 유추해 낼 수 있다.

## 전이함수모형의 적합(fitting transfer function model)

1. 먼저 분석에 이용될 시계열들이 정상이라는 가정을 만족하도록 정상화한다.

2. 전이함수모형의 식별을 위해 시계열을 사전백색화(prewhitening)한다.

3. 잠정적인 전이함수모형을 추정한다.

4. 장차를 이용하여 오차모형을 식별하고 추정한다.

## R 예제(R-transfer)

```{r, message=F, echo=F}
library(astsa)
library(TSA)
```

### SOI example

[@Shumway2010]에 있는 예제다.

```{r, fig.align='center', comment=">", fig.cap = 'Sample ACF and PACF of SOI.'}
acf2(soi)
(fit = arima(soi, xreg=time(soi), order=c(1, 0, 0)))
```

```{r, fig.align='center', comment=">", fig.cap = 'Sample CCF of prewhitened and detrended SOI.'}
ar1 = as.numeric(fit$coef[1])    # = 0.5875387
soi.pw = resid(fit)  
rec.d = resid(lm(rec~time(rec), na.action=NULL))  
rec.fil = filter(rec.d, filter=c(1, -ar1), method="conv", sides=1)
ccf(soi.pw, rec.fil, main="", ylab="CCF", na.action=na.omit)
```

### Monthly milk production and electricity production

[@Cryer2008]에 있는 예제다. 월 우유 생산과 전력 생산자료에 대해 전이함수모형을 적용한다. 전력 생산자료에 로그를 취해 분석한다. R `TSA` 패키지를 이용한다.

```{r, fig.align='center', comment=">", fig.cap = 'Montly milk production and logarithms of monthly electricity production in the U.S.'}
data(milk); data(electricity)
milk.electricity=ts.intersect(milk,log(electricity))
plot(milk.electricity,yax.flip=T)
```

자료의 기간은 1994년 1월부터 2005년 12월까지다. 두 시계열 모두 upward trend 및 highly seasonal함을 확인할 수 있다.

```{r, fig.align='center', comment=">", fig.cap = 'Sample cross-correlation between monthly milk production and logrithm of monthly electricity production in the U.S.'}
ccf(as.vector(milk.electricity[,1]), as.vector(milk.electricity[,2]),ylab='CCF')
```

교차상관계수 그림은 lag 0에서 0.54로, '통계적으로 0이 아니다'라고 볼 수 있는 값이다. (비교를 위한 standard error는 $1.96\sqrt{n}=0.16$이다.) 교차상관계수 그림으로부터 두 변수는 a large number of lags에서 강한 교차상관을 가지고 있음을 보여준다.

다만 두 시계열의 비정상성은 두 시계열의 correlation 분석에 어려움을 준다. 이를 해결하는 방법은 후술할 것이다.

**whitening** 또는 **prewhitening**을 시도해보자. 이 사전백색화는 선형연산자이므로, 두 시계열간의 어떠한 선형관계도 사전백색화 이후에도 고스란히 보존된다. 사전백색화의 장점은 다음과 같다.

1. Standard error cutoff가 $1.96\sqrt{n}=0.16$로 유지됨

2. The theoretical counterpart of the CCF so estimated is proportional to certain regression coefficients

결국 이 시계열들은 

1. Regular differencing

2. Seasonal differencing

을 먼저 실행한 후 이 차분된 시계열에 사전백색화를 실행해야 한다는 결론이 나온다.

```{r, fig.align='center', comment=">", fig.cap = 'Sample CCF of prewhitened milk and electricity production.'}
me.dif=ts.intersect(diff(diff(milk,12)),
diff(diff(log(electricity),12)))
prewhiten(as.vector(me.dif[,1]),as.vector(me.dif[,2]),
ylab='CCF')
```

위 그림은 사전백색화를 실행한 두 시계열간의 sample CCF 그림을 보여준다. lag -3에서 약간 significant하게 나온다. 결국 우유 생산량과 전기 소비량은 uncorrelated되어있으며 cross-correlation patern은 가짜(즉 differencing으로 filtering할 수 있다는 뜻인드)라고 볼 수 있다.

### 포테이토칩 판매량과 가격 데이터(sales and price dataset of certain potato chip)

이 자료는 뉴질랜드 블루버드 식품회사의 포테이토칩 판매량과 가격 데이터이다.

```{r, fig.align='center', comment=">", fig.cap = 'Weekly log(sales) and price for Bluebird Potato Chips.'}
data(bluebird)
plot(bluebird,yax.flip=T)
```

`sales` 데이터가 skewed 되어있기 때문에 log변환이 필요하다고 한다. 이 자료는 분명히 nonstationary한 자료다.

```{r, fig.align='center', comment=">", fig.cap = 'Weekly log(sales) and price for Bluebird Potato Chips.'}
prewhiten(y=diff(bluebird)[,1],
          x=diff(bluebird)[,2],ylab='CCF')
```

차분과 사전백색화를 한 후 CCF를 그려보았다. 이 때 lag 0에서만 significant한데, 이것은 lag 1 of price와 sales간의 강한 negative relationship을 보여준다고 한다. (확인 필요)

```{r, fig.align='center', comment=">", fig.cap = 'Sample ACF of residuals from OLS regression of log(sales) on price.'}
sales=bluebird[,1]; price=bluebird[,2]
chip.m1=lm(sales~price,data=bluebird)
summary(chip.m1)
acf(residuals(chip.m1),ci.type='ma')
```

```{r, fig.align='center', comment=">", fig.cap = 'Sample PACF of residuals from OLS regression of log(sales) on price.'}
pacf(residuals(chip.m1))
```

`log(sales)`와 `price`간의 회귀분석 결과 residual이 sample ACF와 PACF의 결과로부터 autocorrelated되어있기 때문에(실제로 ACF는 lag 4까지 significant하고 PACF는 lag 1, 2, 4, 14에서 significant함) 일단 residual의 sample EACF를 구해본다.

```{r, fig.align='center', comment=">", fig.cap = 'The sample EACF of the residuals from the OLS regression of log(sales) on price.'}
eacf(residuals(chip.m1))
```

EACF 결과는 ARMA(1,4)를 지지해주므로 `log(sales)`와 `price` 사이에 ARMA(1,4) error를 가진 regression model을 적합해 보기로 한다.

```{r, fig.align='center', comment=">", fig.cap = 'MLE of a regression model of log(sales) on price with a subset MA(4) for the errors.'}
chip.m2=arima(sales,order=c(1,0,4),xreg=data.frame(price))
chip.m2
chip.m3=arima(sales,order=c(1,0,4),xreg=data.frame(price),
fixed=c(NA,0,NA,0,NA,NA,NA)); chip.m3
chip.m4=arima(sales,order=c(0,0,4),xreg=data.frame(price),
fixed=c(0,NA,0,NA,NA,NA)); chip.m4
```

`price`의 회귀분석 계수는 OLS 회귀분석 결과와 비슷하다. 그러나 standard error of the estimate가 10% 정도 낮아졌음을 확인할 수 있다. 이것은 simple OLS estimator가 consistent하나 standard error는 신뢰할 수 없음을 보여준다.

### 가솔린 가격과 대중교통 이용 자료(gasoline price on public transportation)

```{r, fig.align='center', comment=">", fig.cap = 'Logarithms of monthly public transit boardings and gasoline prices in Denver.'}
data(boardings)
plot(boardings,yax.flip=T)
```

이 자료는 2000년 8월부터 2006년 3월까지 덴버 지역의 월별 가솔린 평균가격과 대중교통 이용자 수를 담았다. 두 변수들 모두 skewed되어 있어 log-변환을 했다. 다음 결과에서도 확인하겠지만, 로그변환은 적합하는 모형을 좀 더 설명가능하게 한다.

위 그림에 나타난 시계열은 가솔린 가격과 대중교통 이용 자료 모두에서 trend와 seasonal fluctuation을 보여준다. Sample ACF와 PACF에 기반해 가솔린 가격 자료에 ARIMA(2,1,0)을 적용해보기로 한다. 적합한 모형은 CCF를 적합하기 전 필터로 사용하기로 한다.

```{r, fig.align='center', comment=">", fig.cap = 'Sample CCF of prewhitened log(boardings) and log(price).'}
m1=arima(boardings[,2],order=c(2,1,0))
prewhiten(x=boardings[,2],y=boardings[,1],x.model=m1)
```

CCF는 가솔린 가격과 대중교통 이용자 수 간에 lag 15에서 유의한 관계가 있음을 보여준다. 믿기 어렵고 왜 그런지는 모르겠지만 일단 AR(16) 모형을 적용해보기로 한다. 결국 이 예제는 모형선택시 단순히 AIC만 믿지는 말라는 교훈을 주고 있다.

```{r, fig.align='center', comment=">", fig.cap = 'MLE of the regression model of log(boardings) on log(price) with ARMA errors.'}
log.boardings=boardings[,1]
log.price=boardings[,2]
boardings.m1=arima(log.boardings,order=c(1,0,0), seasonal=list(order=c(1,0,0),period=12),
xreg=data.frame(log.price))
boardings.m1
detectAO(boardings.m1); detectIO(boardings.m1)
boardings.m2=arima(log.boardings,order=c(1,0,3),
seasonal=list(order=c(1,0,0),period=12),
xreg=data.frame(log.price,outlier=c(rep(0,31),1,rep(0,36))),
fixed=c(NA,0,0,rep(NA,5)))
boardings.m2
detectAO(boardings.m2); detectIO(boardings.m2)
tsdiag(boardings.m2,tol=.15,gof.lag=24)
```

Linear model of boardings on gasoline price의 residual의 sample ACF, PACF 그리고 EACF에 기반해 계절 ARIMA$(2,0,0)\times (1,0,0)_{12}$ 모형을 적합하기로 한다. $\phi_{2}$가 significant하지 않아서, AR order를 $p=1$로 줄인다. 회귀 진단 결과는 계절 ARIMA$(1,0,3)\times(1,0,0)_{12}$+ outlier process를 제시한다.
