# 완전공간임의성 {#csr}

공간점패턴 자료를 받으면 제일 처음으로 이 자료가 **완전공간임의성(complete spatial randomness, CSR)**을 따르는지 체크하게 되는데, 그 이유는 이것을 따르면 모델링이 단순해지기 때문이다.

<div class="definition">

완전공간임의성 가정은 다음 두 조건

1. 면적이 $|A|$인 관찰 지역 $A$ 안의 사건의 숫자가 $\text{Poisson}(\lambda |A|), \lambda >0, |A| >0$을 따른다.

2. $n$개의 사건이 주어졌을 때, 각각의 사건들 $x_{i}, i=1,\ldots , n$은 $A$ 위에서 균등분포(uniform distribution)를 따르는 독립인 무작위 표본들이다.

을 만족하는 것이다. 이를 만족하는 점과정을 특별히 **동질적 포아송 점과정(homogeneous Poisson point process)**이라고 부른다. $\lambda$는 강도(intensity)로 단위 면적 당 사건 발생의 기대값을 결정하는 값이다. $\lambda$가 위치에 관계 없는 상수값이라는 것은 사건의 발생횟수가 위치에 따라 변하지 않는다는 의미이다. 또한 CSR 가정은 사건들 사이에 어떤 상호작용도 존재하지 않음을 의미한다.

</div>

우리는 어떤 자료가 정규분포를 따르는지 알아보기 위해 평균, 분산, 왜도, 첨도 등을 체크하고 Q-Q plot 등을 그리기도 한다. 그렇다면 CSR의 특징은 무엇인가? 이를 알먄 어떤 자료가 CSR을 따르는지 체크 가능할 것이다.

## 일반적인 몬테카를로 검정 (general Monte Carlo test)

$u_{1}$을 통계량 $U$ (아마 확률번수인 듯)를 따르는 관찰값이라고 하자. 그리고 $u_{i}, i =2,\ldots, s$를 어떤 단순한 가정($H_{0}$) 하의 $U$의 분포에서 뽑힌 독립 표본들의 값이라고 하자. $u_{(j)}$를 $u_{i}, i=1,\ldots , s$ 중 $j$번째로 큰 순서통계량이라고 하자. 그러면
$$P(u_{i}=u_{(j)})=\frac{1}{s} \qquad{\text{under } H_{0}},$$
$$P(u_{i}\geq u_{(j)})=\frac{k}{s}=\text{(test의) size} \qquad{\text{(one-sided test)}}$$
가 된다.

이 때 $U$는 동률이 없는 연속인 경우를 일단 생각한다. 만약 $U$가 이산이라면 동률이 생겨 rank 계산에 문제가 생길 것이다. 이 때는 less extreme rank(?)를 하는게 보수적인 판단이라고 한다.

갑자기 몬테카를로 검정을 이야기 한 이유는 어떤 자료가 CSR인지 테스트를 할 때 사용할 수 있기 때문이다.

1. 관찰값들이 있으면 이들의 상호 떨어지 거리(inter-event distance)를 이용하는 것이다. $T$를 지역 $A$ 안에서 독립인 균등분포로 뽑힌 두 사건의 거리들이라고 하자. 관찰 지역이 원이나 정사각형인 경우 $T$의 분포의 명시적 형태가 존재한다. 이 때 명시적 형태는 다음과 같다.

단위 정사각형의 경우, 분포함수 $H(t)$는
$$
H(t)=P(T\leq t) =
\begin{cases}
\pi t^{2}-\frac{8}{3}t^{3}+\frac{1}{2}t^{4} & \text{if $0 \leq t \leq 1$}\\
\frac{1}{3} -2t^{2} + \frac{1}{2}t^{4} + 4(t^{2}-1)^{\frac{1}{2}}(2t^{2}+1)/3\\
+ 2t^{2}\sin^{-1}(2t^{-2}-1) & \text{if $1\leq t \leq \sqrt{2}$}
\end{cases}
$$
이다. 식이 복잡해 보이는데 $a_{1}=(x_{1},y_{1})$, $a_{2}=(x_{2},y_{2})$일 때 $x_{1}, x_{2}, y_{1}, y_{2}$가 모두 독립이고 이 때 $T=\sqrt{(x_{1}-x_{2})^{2}+(y_{1}-y_{2})^{2}}$의 CDF를 구한 듯 하다.

단위 원 경우에는 극 좌표계로 변환하여 계산하며
$$H(t)=1+\pi^{-1}\{2(t^{2}-1)\cos^{-1}(\frac{t}{2})-t(1+\frac{t^{2}}{2})\sqrt{1-t^{2}/4}\}, \qquad{0\leq t \leq 2}$$
가 된다.

위 사각형 예제에서, H(t)의 경험적 분포함수(empirical distribution function) $\hat{H}(t)$는
$$\hat{H}(t)=\frac{2}{n(n-1)}\sum_{i,j}^{i\neq j}I_{(t_{ij}\leq t)}$$
이며 이 때 empirical distribution function (EDF) 그림은 q-q plot과 비슷하게 그려진다.

한편, EDF에 봉투(envelope)들(마치 함수의 상한, 하한과 같다) $U(t)$, $L(t)$을 다음과 같이 정의한다.
$$U(t)=\max_{2\leq i \leq s}\{\hat{H}_{i}(t)\} \text{ and } U(t)=\min_{2\leq i \leq s}\{\hat{H}_{i}(t)\}.$$

이 ED 말고 통계량을 이용해 검정할 수는 없을까? 그러기 위해서는 우선 $\hat{H}(t)$의 분포를 알아야 한다. 그러나 이를 구하는 것은 쉽지 않다. 따라서 공간점과정에서는 몬테칼로 방법(Monte Carlo method)을 많이 사용한다고 한다. 일반적인 절차는

1. CSR 가정 하에 지역 $A$ 안에서 $n$개의 사건을 생성한다.

2. 간단히 하기 위해 먼저 $t$를 고정시킨 다음, $\hat{H}_{1}(t)$ 는 데이터로부터 생성된 

## R 예제(R-edf)

```{r, message=F, echo=F}
library(spatstat)
library(ape)
```

```{r, fig.align='center', comment=">", fig.cap = 'EDF plot.'}
# Define points
x <- c(3.4, 7.3, 6.3, 7.7, 5.2, 0.3, 6.8, 7.5, 5.4, 6.1, 5.9, 3.1, 5.2, 1.4, 5.6, 0.3)
y <- c(2.2, 0.4, 0.8, 6.6, 5.6, 2.5, 7.6, 0.3, 3.5, 3.1, 6.1, 6.4, 1.5, 3.9, 3.6, 5.2)
# Store the coordinates as a matrix
coords <- as.matrix(cbind(x, y))
# Store the points as two-dimensional point pattern (ppp) object (ranging from 0 to 8 on both axis)
coords.ppp <- as.ppp(coords, c(0, 8, 0, 8))
#  Number of points
n <- coords.ppp$n
#  We want to generate completely spatially random point patterns to compare against the observed
ex <- expression( runifpoint( n , win = owin(c(0,8),c(0,8))))
#  Reproducible simulation
set.seed(1)
# Compute a simulation envelope using Gest, which estimates the nearest neighbour distance distribution function G(r)
EDF <- envelope( coords.ppp , Gest , nsim = 99, simulate = ex ,verbose = FALSE, savefuns = TRUE )
#  Plot
plot(EDF)
```
